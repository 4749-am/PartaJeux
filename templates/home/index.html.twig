{% extends 'base.html.twig' %}

{% block title %}PartaJeux — Soirées jeux{% endblock %}

{% block body %}
<h1 class="desktop-title">Soirées jeux autour de chez vous</h1>

<div id="map" style="height:400px;"></div>

<div class="panel">
  <h2>Liste des jeux disponibles</h2>
  <div id="gameList">
    {% for jeu in jeux %}
      <div class="game-card">
        <div>
          <div class="game-title">{{ jeu.titre }}</div>
          <div>{{ jeu.dateSoiree|date('d/m/Y H:i') }} — {{ jeu.ville }}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="places">Nombre de places disponibles: {{ jeu.getNombrePlacesRestantes() }}</div>
          {% if app.user %}
            <form action="{{ path('app_game_join', {'id': jeu.id}) }}" method="post">
              <input type="hidden" name="_token" value="{{ csrf_token('join' ~ jeu.id) }}">
              <button type="submit" class="join-btn" {{ jeu.getNombrePlacesRestantes() == 0 ? 'disabled' : '' }}>S'inscrire</button>
            </form>

          {% else %}
            <a href="{{ path('app_login') }}" class="join-btn">S'inscrire</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p>Aucun jeu disponible.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const jeux = {{ jeux|map(j => {
    titre: j.titre,
    ville: j.ville,
    lat: j.latitude,
    lon: j.longitude,
    date: j.dateSoiree ? j.dateSoiree|date('d/m/Y H:i') : '',
    places: j.getNombrePlacesRestantes(),
    user: j.user ? j.user.username : 'Anonyme'
  })|json_encode|raw }};

  function initMap() {
    let map = L.map('map').setView([46.6, 2.4], 6);
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);

    const purpleMarker = L.divIcon({
      html: `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 30 40">
              <path d="M15 0C7 0 0 7 0 15c0 10 15 25 15 25s15-15 15-25C30 7 23 0 15 0z" fill="var(--neon-purple)" stroke="white" stroke-width="1"/>
            </svg>`,
      className: "neon-marker",
      iconAnchor: [15, 40]
    });

    const style = document.createElement("style");
    style.textContent = `.neon-marker svg { filter: drop-shadow(0 0 6px var(--neon-purple)) drop-shadow(0 0 12px var(--neon-purple)); }`;
    document.head.appendChild(style);

    jeux.forEach(j => {
      if (j.lat && j.lon) {
        const marker = L.marker([j.lat,j.lon], {icon: purpleMarker}).addTo(map);
        marker.bindPopup(`<b>${j.titre}</b><br>${j.ville}<br>${j.date}<br>${j.places} places restantes<br>Créé par: ${j.user}`);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", initMap);
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById('searchInput');
  const gameCards = document.querySelectorAll('#gameList .game-card');

  searchInput.addEventListener('input', () => {
    const value = searchInput.value.toLowerCase();
    gameCards.forEach(card => {
      const titre = card.querySelector('.game-title').textContent.toLowerCase();
      const ville = card.querySelector('div:nth-child(2)').textContent.toLowerCase();
      card.style.display = (titre.includes(value) || ville.includes(value)) ? 'flex' : 'none';
    });
  });
});
</script>

{% endblock %}
