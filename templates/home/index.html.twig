{% extends 'base.html.twig' %}

{% block title %}PartaJeux — Soirées jeux{% endblock %}

{% block body %}
  <h1 class="desktop-title" id="titleDesktop">Soirées jeux autour de chez vous</h1>
  <h1 class="mobile-title" id="titleMobile">Trouver un jeu</h1>

  <div id="map"></div>

  <div class="panel">
    <h2 id="subtitle">Liste des jeux disponibles</h2>
    <div id="gameList">
      {% for jeu in jeux %}
        <div class="game-card">
          <div>
            <div class="game-title">{{ jeu.titre }}</div>
            <div>
              {{ jeu.dateSoiree|date('d/m/Y H:i') }} — {{ jeu.ville }}
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="places">{{ jeu.nombrePlaces }} places</div>
            {% if app.user %}
              <button class="join-btn">S'inscrire</button>
            {% else %}
              <a href="{{ path('app_login') }}" class="join-btn">Se connecter</a>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p>Aucun jeu disponible pour le moment.</p>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  const jeux = {{ jeux|map(j => {
    titre: j.titre,
    ville: j.ville,
    lat: j.latitude,
    lon: j.longitude,
    date: j.dateSoiree ? j.dateSoiree|date('Y-m-d H:i') : '',
    places: j.nombrePlaces
  })|json_encode|raw }};

  function initMap(){
    let map = L.map('map').setView([46.6, 2.4], 6);
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);

    const purpleMarker = L.divIcon({
      html: `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 30 40">
              <path d="M15 0C7 0 0 7 0 15c0 10 15 25 15 25s15-15 15-25C30 7 23 0 15 0z" fill="var(--neon-purple)" stroke="white" stroke-width="1"/>
            </svg>`,
      className: "neon-marker",
      iconAnchor: [15, 40]
    });

    const style = document.createElement("style");
    style.textContent = `
      .neon-marker svg {
        filter: drop-shadow(0 0 6px var(--neon-purple)) drop-shadow(0 0 12px var(--neon-purple));
      }
    `;
    document.head.appendChild(style);

    jeux.forEach(j => {
      if (j.lat && j.lon) {
        const marker = L.marker([j.lat, j.lon], { icon: purpleMarker }).addTo(map);
        marker.bindPopup(`<b>${j.titre}</b><br>${j.ville}<br>${j.date}<br>${j.places} places`);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", initMap);
</script>
{% endblock %}
