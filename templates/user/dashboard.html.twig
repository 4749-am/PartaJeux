{% extends 'base.html.twig' %}

{% block title %}Espace Utilisateur{% endblock %}

{% block body %}
<div class="dashboard-wrap">
  <!-- En-tête -->
  <div class="header-row">
    <h1>Bienvenue, {{ app.user.username }}</h1>
    <p>Crée et rejoins des soirées jeux près de chez toi</p>
    <div class="actions">
      <a href="{{ path('app_logout') }}" class="btn-cyberpunk">Se déconnecter</a>
    </div>
  </div>

  <!-- Création d’un nouveau jeu -->
  <div class="cyber-card">
    <h2 style="color:var(--neon-purple); text-align:center; margin-bottom:12px;">
      Créer un nouveau jeu
    </h2>

    {{ form_start(form, {'attr': {'class':'cyber-form'}, 'novalidate': 'novalidate'}) }}

    <div class="form-field">
      {{ form_label(form.titre, 'Nom du jeu') }}
      {{ form_widget(form.titre, {'attr': {'class':'cyber-input'}}) }}
    </div>

    <div class="form-field">
      {{ form_label(form.description, 'Description') }}
      {{ form_widget(form.description, {'attr': {'class':'cyber-input'}}) }}
    </div>

    <div class="form-field">
      {{ form_label(form.ville, 'Ville') }}
      {{ form_widget(form.ville, {'attr': {'class':'cyber-input'}}) }}
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;">
        {{ form_row(form.latitude, {'attr': {'class':'cyber-input'}}) }}
      </div>
      <div style="flex:1;">
        {{ form_row(form.longitude, {'attr': {'class':'cyber-input'}}) }}
      </div>
    </div>

    <div class="form-field">
      {{ form_label(form.dateSoiree, 'Date et heure de la soirée') }}
      {{ form_widget(form.dateSoiree, {'attr': {'class':'cyber-input'}}) }}
    </div>

    <div class="form-field">
      {{ form_label(form.nombrePlaces, 'Nombre total de places') }}
      {{ form_widget(form.nombrePlaces, {'attr': {'class':'cyber-input'}}) }}
    </div>

    <div style="text-align:center; margin-top:10px;">
      <button type="submit" class="btn-cyberpunk">Créer le jeu</button>
    </div>

    {{ form_end(form) }}
  </div>

  <!-- Vos jeux -->
  <div class="cyber-card">
    <h2 style="color:var(--neon-blue); text-align:center; margin-bottom:12px;">Vos jeux</h2>

    <table class="cyber-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Ville</th>
          <th>Date</th>
          <th>Places disponibles</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for jeu in app.user.jeux %}
          <tr>
            <td>{{ jeu.titre }}</td>
            <td>{{ jeu.ville }}</td>
            <td>{{ jeu.dateSoiree ? jeu.dateSoiree|date('d/m/Y H:i') : '' }}</td>
            <td>{{ jeu.getNombrePlacesRestantes() }} / {{ jeu.nombrePlaces }}</td>
            <td style="white-space: nowrap; text-align:center;">
              <div style="display:flex; justify-content:center; gap:10px;">
                <a href="{{ path('app_game_show', {'id': jeu.id}) }}" class="btn-cyberpunk">Voir</a>
                <a href="{{ path('app_game_edit', {'id': jeu.id}) }}" class="btn-cyberpunk">Modifier</a>
                <form action="{{ path('app_game_delete', {'id': jeu.id}) }}" method="post" onsubmit="return confirm('Supprimer ce jeu ?');">
                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ jeu.id) }}">
                  <button type="submit" class="btn-cyberpunk" style="background-color:var(--neon-pink);">Supprimer</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" style="text-align:center;">Aucun jeu créé pour le moment.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Autres jeux disponibles -->
  <div class="cyber-card">
    <h2 style="color:var(--neon-blue); text-align:center;">Autres jeux disponibles</h2>

    <table class="cyber-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Ville</th>
          <th>Date</th>
          <th>Places disponibles</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for jeu in autresJeux %}
          <tr>
            <td>{{ jeu.titre }}</td>
            <td>{{ jeu.ville }}</td>
            <td>{{ jeu.dateSoiree ? jeu.dateSoiree|date('d/m/Y H:i') : '' }}</td>
            <td>{{ jeu.getNombrePlacesRestantes() }} / {{ jeu.nombrePlaces }}</td>
            <td style="white-space: nowrap; text-align:center;">
              {% if app.user %}
                {% if jeu.participants.contains(app.user) %}
                  <form action="{{ path('app_game_leave', {'id': jeu.id}) }}" method="post" style="display:inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('leave' ~ jeu.id) }}">
                    <button type="submit" class="btn-cyberpunk" style="background-color:var(--neon-purple);">
                      Se désinscrire
                    </button>
                  </form>
                {% else %}
                  <form action="{{ path('app_game_join', {'id': jeu.id}) }}" method="post" style="display:inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('join' ~ jeu.id) }}">
                    <button type="submit" class="btn-cyberpunk" {{ jeu.getNombrePlacesRestantes() == 0 ? 'disabled' : '' }}>
                      S'inscrire
                    </button>
                  </form>
                {% endif %}
              {% else %}
                <a href="{{ path('app_login') }}" class="btn-cyberpunk">Se connecter</a>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" style="text-align:center;">Aucun autre jeu disponible pour le moment.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="cyber-card">
    <h2 style="color:var(--neon-purple); text-align:center;">Utilisateurs</h2>

    <table class="cyber-table">
        <thead>
        <tr>
            <th>Utilisateur</th>
            <th>Email</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for u in utilisateurs %}
            <tr>
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>
                    {% if u.isBanned %}
                        <span style="color:red;">Banni</span>
                    {% else %}
                        <span style="color:green;">Actif</span>
                    {% endif %}
                </td>

                <td style="white-space:nowrap;">
                    {% if 'ROLE_ADMIN' in u.roles %}
                        <span style="color:grey;">(admin protégé)</span>
                    {% else %}
                        {% if u.isBanned %}
                            <a href="{{ path('user_unban', {id: u.id}) }}" class="btn-cyberpunk">Débannir</a>
                        {% else %}
                            <a href="{{ path('user_ban', {id: u.id}) }}" class="btn-cyberpunk" style="background-color:var(--neon-pink);">
                                Bannir
                            </a>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

</div>
{% endblock %}
